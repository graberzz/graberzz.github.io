<!DOCTYPE html>
<html>
<head>
	<title>Snake Game</title>
</head>
<body>
	<h3 align="center" style="margin-bottom: 0px;">Score: <span id="score">0</span></h3>
	<div>
		<canvas id="canvas" width="800" height="600" style=" border: 1px solid black; display: block; margin: auto;"></canvas>
	</div>
	<div id="new_game" align="center" style="border: 2px solid grey; padding-bottom: 5px; width: 300px; margin: 10px auto; background-color: cyan;">
		<b style="font-size: 36px; display: block;">New game?</b>
		<button id="btn_newgame" style="width: 100px; height: 40px;">YES</button>
	</div>
	<!--JQuery CDN -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<!--Main logic -->
	<script>
		$(function(){
			var KEYS = {
				LEFT: 37,
				UP: 38,
				RIGHT: 39,
				DOWN: 40,
				SPACE: 32,
			};
			var canvas = $('#canvas')[0];
			var context = canvas.getContext('2d');
			var width = canvas.width;
			var height = canvas.height;
			var food = {x: 0, y: 0}
			var snake;
			var score = 0;
			var startLen = 3;
			var snake_size = 40;
			var snake_speed = 40;
			var interval = 85;
			var direction;
			var opp_dirs = {
				left: 'right',
				up: 'down',
				right: 'left',
				down: 'up'
			}
			var timer;
			context.strokeStyle = 'lime';


			function initialize(){
				interval = 85;
				score = 0;
				clearInterval(timer);
				$('#score').text(score);
				snake = [];
				direction = KEYS.RIGHT;
				var x = snake_size*startLen;
				context.fillStyle = 'white';
				context.fillRect(0, 0, width, height);

				for (let i = startLen; i >= 0; i--){
					var snakeBlock = {
						x: x,
						y: 40
					};
					snake.push(snakeBlock);
					x -= snake_size;
				}
			}


			function gameloop(){
				spawnFood();
				timer = setInterval(function(){
					clearCanvas();

	            	for (var i = snake.length - 1; i > 0; i--){
	                	snake[i].x = snake[i - 1].x;
	                	snake[i].y = snake[i - 1].y;
	  				}

	  				context.fillStyle = 'red';
	  				context.fillRect(food.x, food.y, snake_size, snake_size)

					context.fillStyle = 'black';
					for (let i = 0; i < snake.length; i++)
					{
						context.fillRect(snake[i].x, snake[i].y, snake_size, snake_size);
						context.strokeRect(snake[i].x, snake[i].y, snake_size, snake_size);
					}

					if (collision()){
						$('#new_game').removeAttr('hidden');
						clearCanvas();
						return;
					}

					if (foodEaten()){
						spawnFood();
						score+=10;

						if (score % 100 == 0 && interval > 50)
							interval -= 10;

						$('#score').text(score);
						growSnake();
					}		
					moveSnake();

				}, interval);
			}


			function moveSnake(){
				switch(direction){
					case KEYS.LEFT:
						snake[0].x -= snake_speed;
						break;
					case KEYS.UP:
						snake[0].y -= snake_speed;
						break;
					case KEYS.RIGHT:
						snake[0].x += snake_speed;
						break;
					case KEYS.DOWN:
						snake[0].y += snake_speed;
						break;
				}
			}


			function growSnake(){
				var block = {
					x: 10,
					y: 10,
				}
				snake.push(block);
			}


			function clearCanvas(){
				var fillStyle = context.fillStyle;
				context.fillStyle = 'white';
				context.fillRect(0, 0, width, height);
				context.fillStyle = fillStyle;
			}


			function collision(){
				for (let i = 2; i < snake.length; i++)
					if (snake[0].x == snake[i].x && snake[0].y == snake[i].y)
						return true;
				if (snake[0].x <= 0 - snake_size || snake[0].x >= width + snake_size || snake[0].y <= 0 - snake_size || snake[0].y >= height + snake_size)
					return true;

				return false;
			}


			$(document).keydown(function(e){
				key = e.which;
				switch (key){
					case KEYS.LEFT:
						if (direction != KEYS.RIGHT)
							direction = KEYS.LEFT;
						break;
					case KEYS.UP:
						if (direction != KEYS.DOWN)
							direction = KEYS.UP;
						break;
					case KEYS.RIGHT:
						if (direction != KEYS.LEFT)
							direction = KEYS.RIGHT;
						break;
					case KEYS.DOWN:
						if (direction != KEYS.UP)
							direction = KEYS.DOWN;
						break;
					case KEYS.SPACE:
						if (!$('#new_game').attr('hidden'))
							$('#btn_newgame').trigger('click');
						break;
				}
			})


			function spawnFood(){
				var locIncorrect = false;

				do{
					food.x = Math.round(Math.random() * (width/snake_size)) * snake_size;
					food.y = Math.round(Math.random() * (height/snake_size)) * snake_size;
					for (let i = 0; i < snake.length; i++)
						if (snake[i].x == food.x && snake[i].y == food.y)
							locIncorrect = true;
							break;			
				}
				while(locIncorrect)

				if (food.x == 0)
					food.x += snake_size;
				else if (food.x == width)
					food.x -= snake_size;
				else if (food.y == 0)
					food.y += snake_size;
				else if (food.y == height)
					food.y -= snake_size;

				console.log('Food:\n'+food.x+' : ' + food.y)
			}


			function foodEaten(){
				return snake[0].x == food.x && snake[0].y == food.y;
			}


			$('#btn_newgame').click(function(){
				initialize();
				gameloop();
				$('#new_game').attr('hidden', 'true');
			})


			function getMousePos(canvas, evt) {
    			var rect = canvas.getBoundingClientRect();
    			return {
      				x: evt.clientX - rect.left,
      				y: evt.clientY - rect.top
    			};
			}


			$(canvas).click(function(e){
				mousePos = getMousePos(canvas, e);
				if (snake[0].x < mousePos.x && direction != KEYS.LEFT && direction != KEYS.RIGHT)
					direction = KEYS.RIGHT;
				else if (snake[0].x > mousePos.x && direction != KEYS.RIGHT && direction != KEYS.LEFT)
					direction = KEYS.LEFT;
				else if (snake[0].y < mousePos.y && direction != KEYS.DOWN && direction != KEYS.UP)
					direction = KEYS.DOWN;
				else if (snake[0].y > mousePos.y && direction != KEYS.UP && direction != KEYS.DOWN) 
					direction = KEYS.UP;

			})

		})
	</script>
</body>
</html>